<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>On The Way</title>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type='text/javascript' charset="utf-8" src='jquery-1.4.2.min.js'></script>
    <script src="v3_epoly.js" type="text/javascript"></script>

    <script type="text/javascript">
    var directionsService = new google.maps.DirectionsService();
    var bounds;
    var map;
    var polyline;
    var directionsDisplay;
    var prevpolyline;
    var markers = [];
    
    function initialize() {
      var center = new google.maps.LatLng(38.850033, -100.6500523);
      directionsDisplay = new google.maps.DirectionsRenderer();
      map = new google.maps.Map(document.getElementById('map_canvas'), {
          center: center,
          zoom: 5,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
    }
    function setMarkers() {
      for (var i = 8046; i < polyline.Distance(); i+= 8046) {
        var marker = new google.maps.Marker({
            position: polyline.GetPointAtDistance(i),
            map: map,
          });
          markers.push(marker);
      }
    }

    function clearMarkers() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
    }

    function calcRoute() {
      bounds = new google.maps.LatLngBounds(); 
      directionsDisplay.setMap(map);
      var request = { 
        origin: document.getElementById('start').value,
        destination: document.getElementById('end').value,
        travelMode: google.maps.DirectionsTravelMode.DRIVING 
      };
      polyline = new google.maps.Polyline({
        path: [],
        strokeColor: '#0000FF',
        strokeWeight: 5
      });
      directionsService.route(request, function(result, status) { 
        if (status == google.maps.DirectionsStatus.OK) {
          legs = result.routes[0].legs;
          $(legs).each(function(index, item) {
          steps = item.steps;
          $(steps).each(function(index, item) {
          path = item.path;
          $(path).each(function(index, item) {
            polyline.getPath().push(item);
            bounds.extend(item);
          });
          });
          });
          if (prevpolyline != null) {
            prevpolyline.setMap(null);
          }
          map.fitBounds(bounds);
          clearMarkers();
          polyline.setMap(map);
          setMarkers(polyline);
          directionsDisplay.setMap(map);
          prevpolyline = polyline;
        }
      });
    }
    google.maps.event.addDomListener(window, 'load', initialize);

    </script>
    
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0px; padding: 0px }
      #map_canvas { height: 100% }
    </style>
  </head>
      <div id="panel">
    <b>Start: </b>
    <select id="start">
      <option value="Brisbane, ca">Brisbane, CA</option>
      <option value="Truckee, Ca">Truckee, CA</option>
    </select>
    <b>End: </b>
    <select id="end" onchange="calcRoute()">
      <option value="berkeley, ca">berkeley</option>
      <option value="san mateo, ca">San Mateo</option>
    </select>
    </div>
  <body>
      <div id="map_canvas"></div>
    </script>
  </body>
</html>